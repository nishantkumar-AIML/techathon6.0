<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Page</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .secret { padding: 20px; }
    .hint { font-size: 14px; color: #6b7280; margin-bottom: 12px; }
    .center { text-align:center }
    .small { font-size:13px;color:#6b7280 }
  </style>
</head>
<body>
  <main class="container">
    <div class="card secret" id="root">
      <h1 id="title">Protected Content</h1>
      <div id="locked">
        <p class="hint">Enter the password to view the protected content.</p>
        <form id="unlockForm">
          <div class="field">
            <label for="unlockPassword">Password</label>
            <input id="unlockPassword" type="password" required />
            <div class="error" id="unlockError" aria-live="polite"></div>
          </div>
          <button type="submit">Unlock</button>
        </form>
        <p class="small">Hint: demo password is <code>password123</code></p>
      </div>

      <div id="content" style="display:none">
        <h2>Welcome, <span id="userNameDisplay">user</span>! ðŸŽ‰</h2>
        <p class="hint">Below is your dashboard with live weather and top crypto prices.</p>
        <div id="react-root"></div>
        <div class="center" style="margin-top:16px">
          <button id="logoutBtn">Logout</button>
        </div>
      </div>

    </div>
  </main>

  <script>
    const DEMO_PASS = 'password123';
    const unlockForm = document.getElementById('unlockForm');
    const unlockError = document.getElementById('unlockError');
    const locked = document.getElementById('locked');
    const content = document.getElementById('content');
    const logoutBtn = document.getElementById('logoutBtn');

    function showContent() {
      locked.style.display = 'none';
      content.style.display = 'block';
      document.getElementById('title').textContent = 'Secret Area';
    }

    function isAuthenticated() {
      // sessionStorage set on (successful) login; fallback also sets token in localStorage
      return sessionStorage.getItem('auth') === 'true' || !!localStorage.getItem('token');
    }

    if (isAuthenticated()) {
      // If already authenticated, show content and display username
      const name = sessionStorage.getItem('username') || '';
      const display = document.getElementById('userNameDisplay');
      if (display) display.textContent = name || 'user';
      showContent();
    }

    unlockForm.addEventListener('submit', (e) => {
      e.preventDefault();
      unlockError.textContent = '';
      const pw = document.getElementById('unlockPassword').value || '';
      if (pw === DEMO_PASS) {
        sessionStorage.setItem('auth', 'true');
        // Keep same fake token as server/fallback
        localStorage.setItem('token', 'fake-jwt-token');
        // If username was stored in session, display it
        const name = sessionStorage.getItem('username') || '';
        const display = document.getElementById('userNameDisplay');
        if (display) display.textContent = name || 'user';
        showContent();
      } else {
        unlockError.textContent = 'Incorrect password';
      }
    });

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('auth');
      sessionStorage.removeItem('username');
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    });
    
    // Mount React dashboard when content is shown
    let reactMounted = false;
    function mountDashboard() {
      if (reactMounted) return;
      reactMounted = true;
      // Load React app using CDN + Babel (JSX). This relies on network access.
      // If you prefer a build step, we can replace this with a bundled app.
      const scriptReact = document.createElement('script');
      scriptReact.src = 'https://unpkg.com/react@18/umd/react.development.js';
      document.body.appendChild(scriptReact);
      const scriptReactDOM = document.createElement('script');
      scriptReactDOM.src = 'https://unpkg.com/react-dom@18/umd/react-dom.development.js';
      document.body.appendChild(scriptReactDOM);
      const scriptBabel = document.createElement('script');
      scriptBabel.src = 'https://unpkg.com/@babel/standalone/babel.min.js';
      document.body.appendChild(scriptBabel);

      // After Babel and React are loaded, inject the JSX script
      scriptBabel.onload = () => {
        const jsx = document.createElement('script');
        jsx.type = 'text/babel';
        jsx.text = `
          const { useState, useEffect } = React;
          function Dashboard() {
            const [weather, setWeather] = useState(null);
            const [crypto, setCrypto] = useState([]);

            useEffect(() => {
              fetch('https://api.open-meteo.com/v1/forecast?latitude=51.5072&longitude=-0.1276&current_weather=true')
                .then(res => res.json())
                .then(data => setWeather(data.current_weather))
                .catch(() => {});
            }, []);

            useEffect(() => {
              fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=5')
                .then(res => res.json())
                .then(data => setCrypto(data))
                .catch(() => {});
            }, []);

            return (
              <div style={{padding:12}}>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
                  <div style={{background:'#fff',padding:12,borderRadius:10,boxShadow:'0 6px 18px rgba(12,38,75,0.08)'}}>
                    <h3>ðŸŒ¦ Weather</h3>
                    {weather ? <p>{weather.temperature}Â°C, Wind {weather.windspeed} km/h</p> : <p>Loading...</p>}
                  </div>
                  <div style={{background:'#fff',padding:12,borderRadius:10,boxShadow:'0 6px 18px rgba(12,38,75,0.08)'}}>
                    <h3>ðŸ’° Top Cryptos</h3>
                    <ul>
                      {crypto.map(c => (<li key={c.id}>{c.name}: ${c.current_price}</li>))}
                    </ul>
                  </div>
                </div>
              </div>
            );
          }

          const root = ReactDOM.createRoot(document.getElementById('react-root'));
          root.render(<Dashboard />);
        `;
        document.body.appendChild(jsx);
      };
    }

    // When showing content, mount the dashboard
    const originalShow = showContent;
    showContent = function() {
      originalShow();
      mountDashboard();
    };
  </script>
</body>
</html>